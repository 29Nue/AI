<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ü§ñ AI T·∫°o L·ªãch Tr√¨nh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
   <style>
        body {
            background: linear-gradient(to right, #e0f7fa, #fce4ec);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #333;
        }
        .container-box {
            max-width: 950px;
            margin: 5vh auto;
            padding: 40px;
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #f0f8ff;
        }
        .upload-icon {
            font-size: 3rem;
            color: #0d6efd;
        }
        .result-area {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 12px;
            background-color: #f9f9f9;
        }
        .spinner { display: none; }

        @keyframes sortShake {
        0% { transform: translateY(0); }
        25% { transform: translateY(-4px); }
        50% { transform: translateY(0); }
        75% { transform: translateY(3px); }
        100% { transform: translateY(0); }
        }
        .shake {
        animation: sortShake 0.4s ease;
        }
        
        #filter-date-hoc,
        #filter-subject-hoc,
        #filter-group-hoc {
        font-size: 0.9rem;
        padding: 6px 8px;
        }

        button#filter-btn-hoc,
        button#show-all-btn-hoc,
        button#sort-btn-hoc {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button#filter-btn-hoc:hover,
        button#show-all-btn-hoc:hover,
        button#sort-btn-hoc:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }

    .table {
        font-size: 13px; /* üëà ch·ªânh nh·ªè h∆°n, v√≠ d·ª• 12px hay 11px t√πy em */
    }
    .table th, .table td {
        padding: 4px 6px; /* üëà gi·∫£m kho·∫£ng c√°ch trong √¥ ƒë·ªÉ b·∫£ng g·ªçn h∆°n */
        vertical-align: middle;
    }

    </style>
</head>
<body>
<div class="container-box">
    <h1 class="text-center mb-4">ü§ñ AI T·∫°o L·ªãch Tr√¨nh</h1>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="scheduleTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="hoc-tab" data-bs-toggle="tab" data-bs-target="#hoc" type="button" role="tab">üìö L·ªãch h·ªçc</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="thi-tab" data-bs-toggle="tab" data-bs-target="#thi" type="button" role="tab">üìù L·ªãch thi</button>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="day-tab" data-bs-toggle="tab" href="#day" role="tab">L·ªãch d·∫°y</a>
        </li>
    </ul>

    <div class="tab-content" id="scheduleTabsContent">
        <!-- L·ªãch h·ªçc -->
        <div class="tab-pane fade show active" id="hoc" role="tabpanel">
            <!-- Upload -->
            <div class="upload-area" id="upload-area-hoc" style="cursor: pointer; border: 2px dashed #007bff; border-radius: 10px; padding: 20px; text-align: center;">
                <i class="bi bi-cloud-upload upload-icon"></i>
                <p class="mt-2">K√©o & th·∫£ ·∫£nh <b>l·ªãch h·ªçc</b> v√†o ƒë√¢y ho·∫∑c 
                <label for="file-upload-hoc" class="text-primary" style="cursor:pointer;">t·∫£i l√™n</label>.</p>
                <input type="file" id="file-upload-hoc" accept="image/*" style="display:none" />
            </div>

            <div id="loading-spinner-hoc" class="text-center mt-4 spinner">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">AI ƒëang ph√¢n t√≠ch l·ªãch h·ªçc...</p>
            </div>

            <div id="preview-image-hoc" class="mt-3 text-center" style="display:none;">
                <h5>·∫¢nh l·ªãch h·ªçc:</h5>
                <img id="image-preview-hoc" src="#" alt="·∫¢nh l·ªãch h·ªçc" class="img-fluid rounded shadow-sm" />
            </div>

            <div id="result-area-hoc" class="result-area" style="display:none;">
                <h4 class="text-center mb-3">Th√¥ng Tin L·ªãch H·ªçc</h4>
                <div id="schedule-details-hoc"></div>
            </div>

            <!-- Danh s√°ch theo ng√†y -->
           <div class="mt-4">
            <h4 class="text-center mb-3">üìÖ Danh S√°ch L·ªãch H·ªçc</h4>

            <div class="d-flex justify-content-center align-items-center flex-wrap gap-2 mb-3">
                <input type="date" id="filter-date-hoc" class="form-control w-auto" style="min-width: 160px;">
                <select id="filter-subject-hoc" class="form-select w-auto" style="min-width: 160px;">
                <option value="">-- M√¥n h·ªçc --</option>
                </select>
                <select id="filter-group-hoc" class="form-select w-auto" style="min-width: 160px;">
                <option value="">-- Nh√≥m --</option>
                </select>

                <!-- Nh√≥m n√∫t bi·ªÉu t∆∞·ª£ng -->
                <div class="d-flex align-items-center gap-2 ms-2">
                <button id="filter-btn-hoc" class="btn btn-primary" title="L·ªçc">
                    <i class="bi bi-funnel-fill"></i>
                </button>
                <button id="show-all-btn-hoc" class="btn btn-success" title="Hi·ªán t·∫•t c·∫£">
                    <i class="bi bi-collection"></i>
                </button>
                <button id="sort-btn-hoc" class="btn btn-outline-secondary" title="S·∫Øp x·∫øp">
                    <i class="bi bi-sort-down-alt"></i>
                </button>
                <!-- üÜï N√∫t xu·∫•t Excel -->
                <button id="export-excel-btn" class="btn btn-warning text-white" title="Xu·∫•t Excel">
                    <i class="bi bi-file-earmark-excel"></i>
                </button>
                </div>
            </div>

            <div id="daily-schedule-hoc" class="accordion"></div>
        </div>
        </div>
        <!-- L·ªãch thi -->
        <div class="tab-pane fade" id="thi" role="tabpanel">
            <!-- Upload -->
            <div class="upload-area" id="upload-area-thi" 
                style="cursor: pointer; border: 2px dashed #007bff; border-radius: 10px; padding: 20px; text-align: center;">
                <i class="bi bi-cloud-upload upload-icon" style="font-size: 2rem; color: #007bff;"></i>
                <p class="mt-2">K√©o & th·∫£ ·∫£nh <b>l·ªãch thi</b> v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn ·∫£nh.</p>
                <input type="file" id="file-upload-thi" accept="image/*" style="display:none" />
            </div>

            <div id="loading-spinner-thi" class="text-center mt-4 spinner" style="display:none;">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">AI ƒëang ph√¢n t√≠ch l·ªãch thi...</p>
            </div>

            <div id="preview-image-thi" class="mt-3 text-center" style="display:none;">
                <h5>·∫¢nh l·ªãch thi:</h5>
                <img id="image-preview-thi" src="#" alt="·∫¢nh l·ªãch thi" class="img-fluid rounded shadow-sm" />
            </div>

            <!-- Danh s√°ch l·ªãch thi -->
            <div id="result-area-thi" class="mt-4" style="display:none;">
                <h4 class="text-center mb-3">üìö L·ªãch Thi</h4>

                <!-- Th√¥ng tin k·ª≥ thi -->
                <div id="schedule-details-thi" class="mb-3 text-center text-secondary">
                    <!-- JS s·∫Ω ch√®n th√¥ng tin k·ª≥ thi v√†o ƒë√¢y -->
                </div>

                <!-- H√†ng 1: Ng√†y ‚Äì Kh√≥a ‚Äì M√¥n h·ªçc -->
                <div class="mb-3 d-flex flex-wrap justify-content-center align-items-center gap-2">
                    <input type="date" id="exam-filter-date" class="form-control w-auto" />
                    <select id="exam-filter-course" class="form-select w-auto">
                        <option value="">-- Ch·ªçn kh√≥a --</option>
                    </select>
                    <select id="exam-filter-subject" class="form-select w-auto">
                        <option value="">-- Ch·ªçn m√¥n thi --</option>
                    </select>
                </div>

                <!-- H√†ng 2: N√∫t thao t√°c -->
                <div class="mb-3 d-flex justify-content-center gap-2">
                    <button id="exam-filter-btn" class="btn btn-primary">L·ªçc</button>
                    <button id="exam-show-all-btn" class="btn btn-success">ALL</button>
                    <button id="exam-delete-btn" class="btn btn-danger">X√≥a</button>
                    <button id="exam-export-btn" class="btn btn-warning">Xu·∫•t Excel</button>
                </div>

                <!-- B·∫£ng hi·ªÉn th·ªã l·ªãch thi -->
                <div class="table-responsive">
                    <table class="table table-bordered table-striped align-middle text-center">
                        <thead class="table-primary">
                            <tr>
                                <th>#</th>
                                <th>M√¥n h·ªçc</th>
                                <th>T√≠n ch·ªâ</th>
                                <th>Ng√†y thi</th>
                                <th>Gi·ªù thi</th>
                                <th>Ph√≤ng thi</th>
                                <th>Kh√≥a</th>
                            </tr>
                        </thead>
                        <tbody id="exam-table-body">
                            <!-- JS render ·ªü ƒë√¢y -->
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
        <!-- L·ªãch d·∫°y -->
        <div class="tab-pane fade" id="day" role="tabpanel">
            <!-- Upload ·∫¢nh -->
            <div class="upload-area mb-3" id="upload-area-day" 
                style="cursor: pointer; border: 2px dashed #28a745; border-radius: 10px; padding: 20px; text-align: center;">
                <i class="bi bi-cloud-upload upload-icon" style="font-size: 2rem; color: #28a745;"></i>
                <p class="mt-2">K√©o & th·∫£ ·∫£nh <b>l·ªãch d·∫°y</b> v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn ·∫£nh.</p>
                <input type="file" id="file-upload-day" accept="image/*" style="display:none" />
            </div>

            <!-- Upload File Excel -->
            <div class="upload-area mb-4" id="upload-area-day-excel" 
                style="cursor: pointer; border: 2px dashed #ffc107; border-radius: 10px; padding: 20px; text-align: center;">
                <i class="bi bi-file-earmark-excel upload-icon" style="font-size: 2rem; color: #ffc107;"></i>
                <p class="mt-2">T·∫£i l√™n <b>file Excel</b> ch·ª©a l·ªãch d·∫°y ƒë·ªÉ AI ph√¢n t√≠ch.</p>
                <input type="file" id="file-upload-day-excel" accept=".xls,.xlsx" style="display:none" />
            </div>

            <!-- Loading -->
            <div id="loading-spinner-day" class="text-center mt-4 spinner">
                <div class="spinner-border text-success"></div>
                <p class="mt-2">AI ƒëang ph√¢n t√≠ch l·ªãch d·∫°y...</p>
            </div>

            <!-- Preview ·∫¢nh -->
            <div id="preview-image-day" class="mt-3 text-center" style="display:none;">
                <h5>·∫¢nh l·ªãch d·∫°y:</h5>
                <img id="image-preview-day" src="#" alt="·∫¢nh l·ªãch d·∫°y" class="img-fluid rounded shadow-sm" />
            </div>

            <!-- K·∫øt qu·∫£ AI -->
            <div id="result-area-day" class="result-area" style="display:none;">
                <h4 class="text-center mb-3">Th√¥ng Tin L·ªãch D·∫°y</h4>
                <div id="schedule-details-day"></div>
            </div>

            <!-- Danh s√°ch l·ªãch d·∫°y -->
            <div class="mt-4">
                <h4 class="text-center mb-3">üë©‚Äçüè´ Danh S√°ch L·ªãch D·∫°y</h4>

                <!-- H√†ng l·ªçc -->
                <div class="row justify-content-center mb-3 gx-2">
                    <div class="col-md-2">
                        <input type="date" id="teach-filter-date" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <select id="teach-filter-subject" class="form-select">
                            <option value="">-- M√¥n d·∫°y --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="teach-filter-teacher" class="form-select">
                            <option value="">-- Gi√°o vi√™n --</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="teach-filter-room" class="form-select">
                            <option value="">-- Ph√≤ng --</option>
                        </select>
                    </div>
                </div>

                <!-- H√†ng n√∫t thao t√°c -->
                <div class="text-center mb-4">
                    <button id="teach-filter-btn" class="btn btn-success me-2">
                        <i class="bi bi-funnel"></i> L·ªçc
                    </button>
                    <button id="teach-show-all-btn" class="btn btn-primary me-2">
                        <i class="bi bi-list-ul"></i> ALL
                    </button>
                    <button id="teach-sort-btn" class="btn btn-warning me-2 text-white">
                        <i class="bi bi-sort-alpha-down"></i> S·∫Øp x·∫øp
                    </button>
                    <button id="teach-export-btn" type="button" class="btn btn-outline-success">
                        <i class="bi bi-file-earmark-excel"></i> Xu·∫•t Excel
                    </button>
                </div>
                <div id="teach-schedule" class="accordion"></div>
            </div>
        </div>
    </div>
    <br>
        <a href="/" class="btn btn-outline-secondary mb-4"><i class="bi bi-arrow-left"></i> Quay l·∫°i trang ch·ªß</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const uploadArea = document.getElementById('upload-area-hoc');
const fileInput = document.getElementById('file-upload-hoc');
const previewImageContainer = document.getElementById('preview-image-hoc');
const imagePreview = document.getElementById('image-preview-hoc');
const resultArea = document.getElementById('result-area-hoc');
const scheduleDetails = document.getElementById('schedule-details-hoc');
const loadingSpinner = document.getElementById('loading-spinner-hoc');
// Upload file
uploadArea.addEventListener('click', () => fileInput.click());
['dragenter','dragover','dragleave','drop'].forEach(ev => {
    uploadArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); });
});
['dragenter','dragover'].forEach(ev => uploadArea.addEventListener(ev, () => uploadArea.classList.add('is-dragover')));
['dragleave','drop'].forEach(ev => uploadArea.addEventListener(ev, () => uploadArea.classList.remove('is-dragover')));
uploadArea.addEventListener('drop', e => { const file = e.dataTransfer.files[0]; if(file) handleFile(file); });
fileInput.addEventListener('change', e => { const file = e.target.files[0]; if(file) handleFile(file); });

function handleFile(file){
    resultArea.style.display = 'none';
    loadingSpinner.style.display = 'block';

    const reader = new FileReader();
    reader.onload = e => { imagePreview.src = e.target.result; previewImageContainer.style.display='block'; };
    reader.readAsDataURL(file);

    const formData = new FormData();
    formData.append('file', file);

    fetch('/process_image', { method:'POST', body:formData })
    .then(res=>res.json())
    .then(data=>{ 
        loadingSpinner.style.display='none'; 
        showResult(data); 
        fetchAllSchedules();
    })
    .catch(err=>{
        loadingSpinner.style.display='none';
        console.error(err);
        scheduleDetails.innerHTML = `<div class="alert alert-danger">ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.</div>`;
        resultArea.style.display='block';
    });
}

function showResult(data){
    scheduleDetails.innerHTML='';
    if(!data||Object.keys(data).length===0){
        scheduleDetails.innerHTML = `<div class="alert alert-warning">Kh√¥ng th·ªÉ tr√≠ch xu·∫•t th√¥ng tin t·ª´ ·∫£nh. Vui l√≤ng th·ª≠ ·∫£nh kh√°c.</div>`;
        resultArea.style.display='block';
        return;
    }
    let html=`<div class="row mb-3"><div class="col-md-6"><p><strong>Ng√†y b·∫Øt ƒë·∫ßu h·ªçc:</strong> ${data.start_date||'N/A'}</p></div></div>
    <table class="table table-striped table-hover"><thead><tr class="table-primary">
    <th>Th·ª©</th><th>M√¥n H·ªçc</th><th>Ph√≤ng</th><th>Nh√≥m</th><th>Ti·∫øt</th><th>Th·ªùi gian</th>
    </tr></thead><tbody>`;
    const sorted = data.schedule.sort((a,b)=>{ const days={'Th·ª© Hai':2,'Th·ª© Ba':3,'Th·ª© T∆∞':4,'Th·ª© NƒÉm':5,'Th·ª© S√°u':6,'Th·ª© B·∫£y':7,'Ch·ªß Nh·∫≠t':8}; return days[a.day]-days[b.day]; });
    sorted.forEach(item=>{
        html+=`<tr><td>${item.day||'N/A'}</td><td>${item.subject||'N/A'}</td><td>${item.room||'N/A'}</td><td>${item.group||'N/A'}</td><td>${item.sessions||'N/A'}</td><td>${item.time||'N/A'}</td></tr>`;
    });
    html+='</tbody></table>';
    scheduleDetails.innerHTML=html;
    resultArea.style.display='block';
}

// Filter

function formatDateToDMY(dateStr) {
    if(!dateStr) return "";
    const [yyyy, mm, dd] = dateStr.split("-");
    return `${dd}/${mm}/${yyyy}`;
}

const filterBtn = document.getElementById('filter-btn-hoc');
const showAllBtn = document.getElementById('show-all-btn-hoc');
const filterDate = document.getElementById('filter-date-hoc');
const filterSubject = document.getElementById('filter-subject-hoc');
const filterGroup = document.getElementById('filter-group-hoc');
const dailySchedule = document.getElementById('daily-schedule-hoc');
let allSchedules=[];

function populateFilters() {
    const subjectSet = new Set();
    const groupSet = new Set();

    allSchedules.forEach(s => {
        if(s.subject) subjectSet.add(s.subject);
        if(s.group) groupSet.add(s.group);
    });

    filterSubject.innerHTML = `<option value="">-- Ch·ªçn m√¥n h·ªçc --</option>`;
    filterGroup.innerHTML = `<option value="">-- Ch·ªçn nh√≥m --</option>`;

    subjectSet.forEach(sub => {
        filterSubject.innerHTML += `<option value="${sub}">${sub}</option>`;
    });

    groupSet.forEach(gr => {
        filterGroup.innerHTML += `<option value="${gr}">${gr}</option>`;
    });
}

// Fetch all schedules
function fetchAllSchedules(){
    fetch('/get_all_schedules')
    .then(res=>res.json())
    .then(data=>{
        allSchedules = data;
        populateFilters();
        renderDailySchedule(allSchedules);
    })
    .catch(err=>console.error(err));
}
fetchAllSchedules();

// Filter click
filterBtn.addEventListener('click',()=>{
    const selectedDate = filterDate.value;
    const selectedSubject = filterSubject.value;
    const selectedGroup = filterGroup.value;

    let filtered = allSchedules;
    if(selectedDate) {
        const formattedDate = formatDateToDMY(selectedDate);
        filtered = filtered.filter(s=>s.date===formattedDate);
    }
    if(selectedSubject) filtered = filtered.filter(s=>s.subject===selectedSubject);
    if(selectedGroup) filtered = filtered.filter(s=>s.group===selectedGroup);

    renderDailySchedule(filtered);
});

// Show all
showAllBtn.addEventListener('click', ()=>renderDailySchedule(allSchedules));

function renderDailySchedule(list){
    if(list.length===0){
        dailySchedule.innerHTML='<p class="text-center text-muted">Kh√¥ng c√≥ l·ªãch n√†o üíñ</p>';
        dailySchedule.style.display='block';
        return;
    }
    let html='';
    list.forEach(item=>{
        html+=`<div class="accordion-item">
        <h2 class="accordion-header" id="heading${item.id}">
            <button class="accordion-button collapsed" type="button" 
                data-bs-toggle="collapse" 
                data-bs-target="#collapse${item.id}" 
                aria-expanded="false" 
                aria-controls="collapse${item.id}">
            ${item.subject} (${item.time}) - ${item.day || 'N/A'} - 
            ${item.status==='ch∆∞a'
                ?'üü¢ Ch∆∞a'
                :(item.status==='ho√†n th√†nh'
                    ?'üíñ Ho√†n th√†nh'
                    :'‚ö†Ô∏è Tr·ªÖ')}
        </button>
        </h2>
        <div id="collapse${item.id}" class="accordion-collapse collapse" aria-labelledby="heading${item.id}" data-bs-parent="#daily-schedule">
            <div class="accordion-body">
                <p><strong>Ng√†y:</strong> ${item.date}</p>
                <p><strong>Ph√≤ng:</strong> ${item.room}</p>
                <p><strong>Nh√≥m:</strong> ${item.group}</p>
                <p><strong>Ti·∫øt:</strong> ${item.sessions}</p>
                <div class="d-flex gap-2">
                    <button class="btn btn-success btn-sm" onclick="markComplete(${item.id})">Ho√†n th√†nh üíñ</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteSchedule(${item.id})">X√≥a üóëÔ∏è</button>
                </div>
            </div>
        </div>
        </div>`;
    });
    dailySchedule.innerHTML=html;
    dailySchedule.style.display='block';
}

function markComplete(id){
    const s=allSchedules.find(x=>x.id===id);
    if(s){ 
        s.status='ho√†n th√†nh'; 
        alert(`üíñ ƒê√£ ƒë√°nh d·∫•u "${s.subject}" l√† ho√†n th√†nh`);
        renderDailySchedule(allSchedules.filter(x=>(!filterDate.value||x.date===filterDate.value) && (!filterSubject.value||x.subject===filterSubject.value) && (!filterGroup.value||x.group===filterGroup.value)));
        fetch(`/mark_complete/${id}`, {method:'POST'});
    }
}

function deleteSchedule(id){
    if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch n√†y kh√¥ng?')){
        allSchedules=allSchedules.filter(x=>x.id!==id);
        renderDailySchedule(allSchedules.filter(x=>(!filterDate.value||x.date===filterDate.value) && (!filterSubject.value||x.subject===filterSubject.value) && (!filterGroup.value||x.group===filterGroup.value)));
        fetch(`/delete_schedule/${id}`, {method:'POST'});
    }
}

// --- S·∫Øp x·∫øp l·ªãch h·ªçc ---
document.getElementById("sort-btn-hoc").addEventListener("click", function() {
    fetch("/get_sorted_schedules", { method: "GET" })
        .then(res => res.json())
        .then(data => {
            if (data && data.length > 0) {
                allSchedules = data;
                renderDailySchedule(allSchedules);

                // üåà Hi·ªáu ·ª©ng rung nh·∫π khi s·∫Øp x·∫øp xong
                const list = document.getElementById("schedule-list");
                if (list) {
                    list.classList.add("shake");
                    setTimeout(() => list.classList.remove("shake"), 400);
                }
            } else {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ s·∫Øp x·∫øp.");
            }
        })
        .catch(err => {
            console.error(err);
            alert("L·ªói khi s·∫Øp x·∫øp d·ªØ li·ªáu!");
        });
});

// --- Xu·∫•t Excel ---
document.getElementById("export-excel-btn").addEventListener("click", function () {
    // L·∫•y d·ªØ li·ªáu hi·ªán t·∫°i (to√†n b·ªô ho·∫∑c ƒë√£ l·ªçc)
    const selectedDate = filterDate.value;
    const selectedSubject = filterSubject.value;
    const selectedGroup = filterGroup.value;

    let exportList = allSchedules;

    if (selectedDate) {
        const formattedDate = formatDateToDMY(selectedDate);
        exportList = exportList.filter(s => s.date === formattedDate);
    }
    if (selectedSubject) exportList = exportList.filter(s => s.subject === selectedSubject);
    if (selectedGroup) exportList = exportList.filter(s => s.group === selectedGroup);

    if (exportList.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t üòÖ");
        return;
    }

    // Chu·∫©n b·ªã d·ªØ li·ªáu cho Excel
    const excelData = exportList.map(s => ({
        "Ng√†y": s.date || "",
        "Th·ª©": s.day || "",
        "M√¥n h·ªçc": s.subject || "",
        "Ph√≤ng": s.room || "",
        "Nh√≥m": s.group || "",
        "Ti·∫øt": s.sessions || "",
        "Gi·ªù h·ªçc": s.time || "",
        "Tr·∫°ng th√°i": s.status || "",
    }));

    // T·∫°o sheet & workbook
    const ws = XLSX.utils.json_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "L·ªãch h·ªçc");

    // Th√™m ch√∫t style nh·∫π nh√†ng (t·ª± ƒë·ªông width)
    const colWidths = Object.keys(excelData[0]).map(() => ({ wch: 20 }));
    ws['!cols'] = colWidths;

    // Ghi file
    const fileName = selectedSubject || selectedGroup
        ? `lichhoc_loc_${Date.now()}.xlsx`
        : `lichhoc_full_${Date.now()}.xlsx`;

    XLSX.writeFile(wb, fileName);

    // Hi·ªáu ·ª©ng th√¥ng b√°o
    alert("‚úÖ ƒê√£ xu·∫•t file Excel th√†nh c√¥ng!");
});

// --- L·ªãch Thi ---
const examFilterDate = document.getElementById('exam-filter-date');
const examFilterSubject = document.getElementById('exam-filter-subject');
const examFilterCourse = document.getElementById('exam-filter-course');
const examFilterBtn = document.getElementById('exam-filter-btn');
const examShowAllBtn = document.getElementById('exam-show-all-btn');
const examSchedule = document.getElementById('exam-schedule');
const uploadAreaThi = document.getElementById("upload-area-thi");
const fileUploadThi = document.getElementById("file-upload-thi");

let allExams = [];

// --- Click upload m·ªü file ---
uploadAreaThi.addEventListener("click", () => fileUploadThi.click());

// --- Populate dropdown filter ---
function populateExamFilters() {
    const subjectSet = new Set();
    const courseSet = new Set();

    allExams.forEach(e => {
        if (e.subject) subjectSet.add(e.subject);
        if (e.course) courseSet.add(e.course);
    });

    examFilterSubject.innerHTML = `<option value="">-- Ch·ªçn m√¥n thi --</option>`;
    examFilterCourse.innerHTML = `<option value="">-- Ch·ªçn kh√≥a --</option>`;

    subjectSet.forEach(sub => examFilterSubject.innerHTML += `<option value="${sub}">${sub}</option>`);
    courseSet.forEach(c => examFilterCourse.innerHTML += `<option value="${c}">${c}</option>`);
}

// --- Render l·ªãch thi d·∫°ng b·∫£ng ---
function renderExamSchedule(list) {
    const resultArea = document.getElementById("result-area-thi");
    const tableBody = document.getElementById("exam-table-body");

    if (!tableBody) {
        console.error("Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ #exam-table-body");
        return;
    }

    tableBody.innerHTML = "";

    if (!list || list.length === 0) {
        resultArea.style.display = "block";
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Kh√¥ng c√≥ l·ªãch thi n√†o.</td></tr>`;
        return;
    }

    resultArea.style.display = "block";

    list.forEach((exam, idx) => {
        const row = `
            <tr>
                <td>${idx + 1}</td>
                <td>${exam.subject}</td>
                <td>${exam.credits}</td>
                <td>${exam.date}</td>
                <td>${exam.time}</td>
                <td>${exam.room}</td>
                <td>${exam.course}</td>
            </tr>
        `;
        tableBody.insertAdjacentHTML("beforeend", row);
    });
}

// --- C·∫≠p nh·∫≠t d·ªØ li·ªáu exam v√† render ---
function updateExams(newExams) {
    allExams = [...allExams, ...newExams]; // merge d·ªØ li·ªáu
    populateExamFilters();
    renderExamSchedule(allExams);
}

function fetchAllExams() {
    fetch('/get_all_exams')
        .then(res => res.json())
        .then(data => {
            allExams = data || [];
            populateExamFilters();
            renderExamSchedule(allExams);
            document.getElementById("result-area-thi").style.display = "block";
        })
        .catch(err => console.error("L·ªói khi load l·ªãch thi:", err));
}

// --- Chuy·ªÉn ƒë·ªïi date sang DD/MM/YYYY ---
function formatDateToDMY(dateStr){
    if(!dateStr) return "";
    const d = new Date(dateStr);
    const day = String(d.getDate()).padStart(2,'0');
    const month = String(d.getMonth()+1).padStart(2,'0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}

// --- Filter click ---
examFilterBtn.addEventListener('click', () => {
    const selectedDate = formatDateToDMY(examFilterDate.value);
    const selectedSubject = examFilterSubject.value;
    const selectedCourse = examFilterCourse.value;

    let filtered = allExams;
    if(selectedDate) filtered = filtered.filter(e => e.date === selectedDate);
    if(selectedSubject) filtered = filtered.filter(e => e.subject === selectedSubject);
    if(selectedCourse) filtered = filtered.filter(e => e.course === selectedCourse);

    renderExamSchedule(filtered);
});

// --- Show all ---
examShowAllBtn.addEventListener('click', () => renderExamSchedule(allExams));

// --- Upload & x·ª≠ l√Ω ·∫£nh l·ªãch thi ---
fileUploadThi.addEventListener("change", function (event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById("preview-image-thi").style.display = "block";
        document.getElementById("image-preview-thi").src = e.target.result;
    };
    reader.readAsDataURL(file);

    document.getElementById("loading-spinner-thi").style.display = "block";
    document.getElementById("result-area-thi").style.display = "none";

    const formData = new FormData();
    formData.append("file", file);
    formData.append("username", "demo_user");

    fetch("/process_exam_image", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
            document.getElementById("loading-spinner-thi").style.display = "none";
            if (data.error) return alert(data.error);

            const detailsDiv = document.getElementById("schedule-details-thi");
            detailsDiv.innerHTML = "";
            if (data.exam_info)
                detailsDiv.innerHTML += `<p><b>Th√¥ng tin k·ª≥ thi:</b> ${data.exam_info}</p>`;

            if (data.exams && data.exams.length > 0) {
                renderExamSchedule(data.exams);
                updateExams(data.exams);
            }

            document.getElementById("result-area-thi").style.display = "block";
        })
        .catch(err => {
            console.error(err);
            document.getElementById("loading-spinner-thi").style.display = "none";
            alert("C√≥ l·ªói x·∫£y ra khi g·ª≠i ·∫£nh!");
        });
});

// --- Xu·∫•t Excel (L·ªãch Thi) ---
document.getElementById('exam-export-btn').addEventListener('click', function () {
    const selectedDate = examFilterDate.value ? formatDateToDMY(examFilterDate.value) : "";
    const selectedSubject = examFilterSubject.value;
    const selectedCourse = examFilterCourse.value;

    let exportList = allExams;
    if (selectedDate) exportList = exportList.filter(e => e.date === selectedDate);
    if (selectedSubject) exportList = exportList.filter(e => e.subject === selectedSubject);
    if (selectedCourse) exportList = exportList.filter(e => e.course === selectedCourse);

    if (exportList.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t üòÖ");
        return;
    }

    const excelData = exportList.map((e, idx) => ({
        "#": idx + 1,
        "M√¥n h·ªçc": e.subject,
        "T√≠n ch·ªâ": e.credits || "",
        "Ng√†y thi": e.date,
        "Gi·ªù thi": e.time,
        "Ph√≤ng": e.room,
        "Kh√≥a": e.course
    }));

    const ws = XLSX.utils.json_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "L·ªãch Thi");
    ws['!cols'] = Object.keys(excelData[0]).map(() => ({ wch: 20 }));
    XLSX.writeFile(wb, `lichthi_${Date.now()}.xlsx`);
    alert("‚úÖ ƒê√£ xu·∫•t file Excel L·ªãch Thi th√†nh c√¥ng!");
});

// --- X√≥a l·ªãch thi ---
document.getElementById("exam-delete-btn").addEventListener("click", async function () {
    // L·∫•y d·ªØ li·ªáu hi·ªán ƒëang hi·ªÉn th·ªã
    const currentRows = Array.from(document.querySelectorAll("#exam-table-body tr"));
    if (currentRows.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ x√≥a üòÖ");
        return;
    }

    // X√°c ƒë·ªãnh ƒëang l·ªçc hay kh√¥ng
    const filteredDate = document.getElementById("exam-filter-date").value;
    const filteredCourse = document.getElementById("exam-filter-course").value;
    const filteredSubject = document.getElementById("exam-filter-subject").value;

    let examsToDelete = [];

    if (filteredDate || filteredCourse || filteredSubject) {
        // N·∫øu c√≥ l·ªçc, ch·ªâ x√≥a theo ƒëi·ªÅu ki·ªán l·ªçc
        examsToDelete = allExams.filter(e => {
            return (!filteredDate || e.date === filteredDate) &&
                   (!filteredCourse || e.course === filteredCourse) &&
                   (!filteredSubject || e.subject === filteredSubject);
        });
    } else {
        // N·∫øu kh√¥ng l·ªçc, x√≥a t·∫•t c·∫£
        examsToDelete = allExams;
    }

    if (examsToDelete.length === 0) {
        alert("Kh√¥ng c√≥ l·ªãch thi ph√π h·ª£p ƒë·ªÉ x√≥a üòÖ");
        return;
    }

    // C·∫£nh b√°o x√°c nh·∫≠n
    const confirmDelete = confirm(
        filteredDate || filteredCourse || filteredSubject
            ? `‚ö† B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${examsToDelete.length} m√¥n thi n√†y kh√¥ng?`
            : `‚ö† B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a TO√ÄN B·ªò l·ªãch thi kh√¥ng?`
    );

    if (!confirmDelete) return;

    // G·ª≠i request x√≥a ƒë·∫øn Flask
    try {
        const res = await fetch("/delete_exams", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ids: examsToDelete.map(e => e.id) })
        });
        const result = await res.json();

        if (result.success) {
            alert("‚úÖ ƒê√£ x√≥a th√†nh c√¥ng!");
            // C·∫≠p nh·∫≠t l·∫°i d·ªØ li·ªáu tr√™n giao di·ªán
            fetchAllExams();
        } else {
            alert("‚ùå X√≥a th·∫•t b·∫°i!");
        }
    } catch (err) {
        console.error("L·ªói khi x√≥a:", err);
        alert("‚ö† C√≥ l·ªói khi x√≥a d·ªØ li·ªáu!");
    }
});


// --- Load d·ªØ li·ªáu khi trang m·ªü ---
fetchAllExams();


// --- Upload & X·ª≠ l√Ω ·∫¢nh L·ªãch D·∫°y ---
const uploadAreaDay = document.getElementById('upload-area-day');
const fileInputDay = document.getElementById('file-upload-day');
const previewImageContainerDay = document.getElementById('preview-image-day');
const imagePreviewDay = document.getElementById('image-preview-day');
const resultAreaDay = document.getElementById('result-area-day');
const scheduleDetailsDay = document.getElementById('schedule-details-day');
const loadingSpinnerDay = document.getElementById('loading-spinner-day');

// --- Upload & X·ª≠ l√Ω Excel L·ªãch D·∫°y ---
const uploadAreaDayExcel = document.getElementById('upload-area-day-excel');
const fileInputDayExcel = document.getElementById('file-upload-day-excel');

// NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh khi k√©o th·∫£
['dragenter','dragover','dragleave','drop'].forEach(ev => {
    uploadAreaDay.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); });
    uploadAreaDayExcel.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); });
});

// Hi·ªáu ·ª©ng k√©o th·∫£
['dragenter','dragover'].forEach(ev => {
    uploadAreaDay.addEventListener(ev, () => uploadAreaDay.classList.add('is-dragover'));
    uploadAreaDayExcel.addEventListener(ev, () => uploadAreaDayExcel.classList.add('is-dragover'));
});
['dragleave','drop'].forEach(ev => {
    uploadAreaDay.addEventListener(ev, () => uploadAreaDay.classList.remove('is-dragover'));
    uploadAreaDayExcel.addEventListener(ev, () => uploadAreaDayExcel.classList.remove('is-dragover'));
});

// S·ª± ki·ªán click ch·ªçn file
uploadAreaDay.addEventListener('click', () => fileInputDay.click());
uploadAreaDayExcel.addEventListener('click', () => fileInputDayExcel.click());

// S·ª± ki·ªán khi ch·ªçn file
fileInputDay.addEventListener('change', e => { const file = e.target.files[0]; if(file) handleFileDay(file, 'image'); });
fileInputDayExcel.addEventListener('change', e => { const file = e.target.files[0]; if(file) handleFileDay(file, 'excel'); });

// S·ª± ki·ªán th·∫£ file v√†o v√πng upload
uploadAreaDay.addEventListener('drop', e => { const file = e.dataTransfer.files[0]; if(file) handleFileDay(file, 'image'); });
uploadAreaDayExcel.addEventListener('drop', e => { const file = e.dataTransfer.files[0]; if(file) handleFileDay(file, 'excel'); });

// --- H√†m x·ª≠ l√Ω file (·∫£nh ho·∫∑c excel) ---
function handleFileDay(file, type){
    resultAreaDay.style.display = 'none';
    loadingSpinnerDay.style.display = 'block';

    // N·∫øu l√† ·∫£nh th√¨ hi·ªÉn th·ªã preview
    if(type === 'image'){
        const reader = new FileReader();
        reader.onload = e => {
            imagePreviewDay.src = e.target.result;
            previewImageContainerDay.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        previewImageContainerDay.style.display = 'none';
    }

    const formData = new FormData();
    formData.append('file', file);

    const endpoint = type === 'image' ? '/process_image_day' : '/process_excel_day';

    fetch(endpoint, { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => { 
        loadingSpinnerDay.style.display = 'none'; 
        showResultDay(data); 
        fetchAllTeachSchedules();
    })
    .catch(err => {
        loadingSpinnerDay.style.display = 'none';
        console.error(err);
        scheduleDetailsDay.innerHTML = `<div class="alert alert-danger">ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.</div>`;
        resultAreaDay.style.display = 'block';
    });
}

// --- Hi·ªÉn th·ªã k·∫øt qu·∫£ l·ªãch d·∫°y ---
function showResultDay(data){
    scheduleDetailsDay.innerHTML = '';
    if(!data || !data.schedule || data.schedule.length === 0){
        scheduleDetailsDay.innerHTML = `<div class="alert alert-warning">Kh√¥ng th·ªÉ tr√≠ch xu·∫•t th√¥ng tin. Vui l√≤ng th·ª≠ l·∫°i.</div>`;
        resultAreaDay.style.display = 'block';
        return;
    }

    let html = `
    <table class="table table-striped table-hover">
        <thead>
            <tr class="table-success">
                <th>Th·ª©</th>
                <th>Ng√†y</th>
                <th>Kh√≥a</th>
                <th>Nh√≥m</th>
                <th>M√¥n h·ªçc</th>
                <th>Gi·∫£ng vi√™n</th>
                <th>Ti·∫øt</th>
                <th>Ph√≤ng</th>
            </tr>
        </thead>
        <tbody>`;
    data.schedule.forEach(item=>{
        html += `<tr>
            <td>${item.day || 'N/A'}</td>
            <td>${item.date || 'N/A'}</td>
            <td>${item.course || 'N/A'}</td>
            <td>${item.group || 'N/A'}</td>
            <td>${item.subject || 'N/A'}</td>
            <td>${item.teacher || 'N/A'}</td>
            <td>${item.sessions || 'N/A'}</td>
            <td>${item.room || 'N/A'}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    scheduleDetailsDay.innerHTML = html;
    resultAreaDay.style.display = 'block';
}

// --- B·ªô l·ªçc ---
const filterDateDay = document.getElementById('teach-filter-date');
const filterSubjectDay = document.getElementById('teach-filter-subject');
const filterTeacherDay = document.getElementById('teach-filter-teacher');
const filterRoomDay = document.getElementById('teach-filter-room');
const filterBtnDay = document.getElementById('teach-filter-btn');
const showAllBtnDay = document.getElementById('teach-show-all-btn');
const teachSchedule = document.getElementById('teach-schedule');

let allTeachSchedules = [];

function fetchAllTeachSchedules(){
    fetch('/get_all_teach_schedules')
    .then(res=>res.json())
    .then(data=>{
        allTeachSchedules = data;
        populateTeachFilters();
        renderTeachSchedule(allTeachSchedules);
    })
    .catch(err=>console.error(err));
}
fetchAllTeachSchedules();

function populateTeachFilters(){
    const subjectSet = new Set();
    const teacherSet = new Set();
    const roomSet = new Set();

    allTeachSchedules.forEach(s=>{
        if(s.subject) subjectSet.add(s.subject);
        if(s.teacher) teacherSet.add(s.teacher);
        if(s.room) roomSet.add(s.room);
    });

    filterSubjectDay.innerHTML = `<option value="">-- M√¥n d·∫°y --</option>`;
    filterTeacherDay.innerHTML = `<option value="">-- Gi√°o vi√™n --</option>`;
    filterRoomDay.innerHTML = `<option value="">-- Ph√≤ng --</option>`;

    subjectSet.forEach(sub=> filterSubjectDay.innerHTML += `<option value="${sub}">${sub}</option>`);
    teacherSet.forEach(t=> filterTeacherDay.innerHTML += `<option value="${t}">${t}</option>`);
    roomSet.forEach(r=> filterRoomDay.innerHTML += `<option value="${r}">${r}</option>`);
}

function formatDateToDMY(dateStr){
    if(!dateStr) return "";
    const d = new Date(dateStr);
    const day = String(d.getDate()).padStart(2,'0');
    const month = String(d.getMonth()+1).padStart(2,'0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}

// --- L·ªçc ---
filterBtnDay.addEventListener('click', ()=>{
    const selectedDate = formatDateToDMY(filterDateDay.value); // ƒë·ªïi sang DD/MM/YYYY
    const selectedSubject = filterSubjectDay.value;
    const selectedTeacher = filterTeacherDay.value;
    const selectedRoom = filterRoomDay.value;

    let filtered = allTeachSchedules;
    if(selectedDate) filtered = filtered.filter(s=>s.date === selectedDate);
    if(selectedSubject) filtered = filtered.filter(s=>s.subject === selectedSubject);
    if(selectedTeacher) filtered = filtered.filter(s=>s.teacher === selectedTeacher);
    if(selectedRoom) filtered = filtered.filter(s=>s.room === selectedRoom);

    renderTeachSchedule(filtered);
});

showAllBtnDay.addEventListener('click', ()=>renderTeachSchedule(allTeachSchedules));

// --- Hi·ªÉn th·ªã Accordion L·ªãch D·∫°y ---
function renderTeachSchedule(list){
    if(list.length===0){
        teachSchedule.innerHTML='<p class="text-center text-muted">Kh√¥ng c√≥ l·ªãch d·∫°y n√†o üë©‚Äçüè´</p>';
        return;
    }
    let html='';
    list.forEach(item=>{
        html+=`
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingTeach${item.id}">
                <button class="accordion-button collapsed" type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#collapseTeach${item.id}" 
                    aria-expanded="false" 
                    aria-controls="collapseTeach${item.id}">
                    ${item.subject} - ${item.teacher} (${item.day}, ${item.date})
                </button>
            </h2>
            <div id="collapseTeach${item.id}" class="accordion-collapse collapse" aria-labelledby="headingTeach${item.id}" data-bs-parent="#teach-schedule">
                <div class="accordion-body">
                    <p><strong>Th·ª©:</strong> ${item.day}</p>
                    <p><strong>Ng√†y:</strong> ${item.date}</p>
                    <p><strong>Kh√≥a:</strong> ${item.course}</p>
                    <p><strong>Nh√≥m:</strong> ${item.group}</p>
                    <p><strong>M√¥n h·ªçc:</strong> ${item.subject}</p>
                    <p><strong>Gi·∫£ng vi√™n:</strong> ${item.teacher}</p>
                    <p><strong>Ti·∫øt:</strong> ${item.sessions}</p>
                    <p><strong>Ph√≤ng:</strong> ${item.room}</p>
                </div>
            </div>
        </div>`;
    });
    teachSchedule.innerHTML = html;
}
// --- S·∫Øp x·∫øp ---
document.getElementById("teach-sort-btn").addEventListener("click", function() {
    allTeachSchedules.sort((a,b)=>{
        if(a.date < b.date) return -1;
        if(a.date > b.date) return 1;
        return a.day.localeCompare(b.day);
    });
    renderTeachSchedule(allTeachSchedules);
});

// --- Xu·∫•t Excel (L·ªãch D·∫°y) ---
document.getElementById("teach-export-btn").addEventListener("click", function () {
    // L·∫•y gi√° tr·ªã filter hi·ªán t·∫°i
    const selectedDate = filterDateDay.value;
    const selectedSubject = filterSubjectDay.value;
    const selectedTeacher = filterTeacherDay.value;
    const selectedRoom = filterRoomDay.value;

    let exportList = allTeachSchedules; // default l√† to√†n b·ªô

    // L·ªçc d·ªØ li·ªáu n·∫øu c√≥ ch·ªçn filter
    if (selectedDate) exportList = exportList.filter(s => s.date === selectedDate);
    if (selectedSubject) exportList = exportList.filter(s => s.subject === selectedSubject);
    if (selectedTeacher) exportList = exportList.filter(s => s.teacher === selectedTeacher);
    if (selectedRoom) exportList = exportList.filter(s => s.room === selectedRoom);

    if (exportList.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t üòÖ");
        return;
    }

    // Chu·∫©n b·ªã d·ªØ li·ªáu cho Excel
    const excelData = exportList.map(s => ({
        "Th·ª©": s.day || "",
        "Ng√†y": s.date || "",
        "Kh√≥a": s.course || "",
        "Nh√≥m": s.group || "",
        "M√¥n h·ªçc": s.subject || "",
        "Gi·∫£ng vi√™n": s.teacher || "",
        "Ti·∫øt": s.sessions || "",
        "Ph√≤ng": s.room || ""
    }));

    // T·∫°o sheet & workbook
    const ws = XLSX.utils.json_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "L·ªãch D·∫°y");

    // T·ª± ƒë·ªông cƒÉn c·ªôt
    ws['!cols'] = Object.keys(excelData[0]).map(() => ({ wch: 20 }));

    // T√™n file kh√°c nhau n·∫øu c√≥ filter
    const fileName = (selectedDate || selectedSubject || selectedTeacher || selectedRoom)
        ? `lichday_filtered_${Date.now()}.xlsx`
        : `lichday_full_${Date.now()}.xlsx`;

    XLSX.writeFile(wb, fileName);
    alert("‚úÖ ƒê√£ xu·∫•t file Excel L·ªãch D·∫°y th√†nh c√¥ng!");
});


</script>
</body>
</html>
